#!/bin/bash

set -e

export GOROOT=${GOROOT:-"$HOME/go"}
if [ ! -d "$GOROOT" ]; then
    echo 'Must set $GOROOT' 1>&2
    exit 2
fi

eval $(gomake -j1 --no-print-directory -f "$GOROOT"/src/Make.inc go-env)
if [ -z "$MAKE_GO_ENV_WORKED" ]; then
    echo 'Failed to initialize Go environment' 1>&2
    exit 2
fi

while [ $# -ne 0 ]; do
    param=$1
    shift
    case $param in
        -I) lib=$1 ; libs="$libs -I$lib"; shift ;;
        -format) format=$1; shift;;
        *) files="$param $files"
    esac
done

downcase()
{
    tr [[:upper:]] [[:lower:]]
}

upcase()
{
    tr [[:lower:]] [[:upper:]]
}

capitalize()
{
    echo $(echo ${1:0:1} | upcase)$(echo ${1:1} | downcase)
}

normalize_format()
{
    if [[ "x$format" == x ]]; then
        format=Dot
    else
        format=$(capitalize $format)
    fi
}

create_main() {
    normalize_format
    cat > _specify_.go <<EOF
package main

import "specify";

var runner specify.Runner = specify.NewRunner();

func After(block specify.AfterFunc) {
	runner.After(block);
}

func Before(block specify.BeforeBlock) {
	runner.Before(block);
}

func Describe(name string, block specify.ExampleGroupBlock) {
	runner.Describe(name, block);
}

func It(name string, block specify.ExampleBlock) {
	runner.It(name, block);
}

func main() {
	specify.AdjustBlockDepth(1);
        reporter := specify.${format}Reporter()
	runner.Run(reporter);
}
EOF
}

run() {
    $GC -o _specify_.$O $libs _specify_.go $files \
        && $LD _specify_.$O \
        && ./$O.out
}

clean() {
    rm -f _specify_.* $O.out
}

clean
create_main
run
clean
